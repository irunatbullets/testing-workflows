name: Discord
run-name: "Discord #${{ github.run_number }}"

permissions:
  contents: write

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  info:
    name: Project Info
    runs-on: ubuntu-latest
    outputs:
      project_version: ${{ steps.set.outputs.project_version }}
      project_full_name: ${{ steps.set.outputs.project_full_name }}
      mc_version: ${{ steps.set.outputs.mc_version }}
      loader_type: ${{ steps.set.outputs.loader_type }}
      changelog: ${{ steps.set.outputs.changelog }}

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Validate files
        run: |
          test -f CHANGELOG.md
          test -f pakku.json
          test -f pakku-lock.json

      - name: Extract info + changelog
        id: set
        run: |
          VERSION=$(grep -m1 '^## ' CHANGELOG.md | sed -E 's/^## \[?([0-9]+\.[0-9]+\.[0-9]+)\]?/\1/')

          if [ -z "$VERSION" ]; then
            echo "Could not determine version"
            exit 1
          fi

          PK_INFO=$(jq '.' pakku.json)
          PK_LOCK=$(jq '.' pakku-lock.json)

          NAME=$(echo "$PK_INFO" | jq -r '.name')
          MC_VERSION=$(echo "$PK_LOCK" | jq -r '.mc_versions[0]')
          LOADER_TYPE=$(echo "$PK_LOCK" | jq -r '.loaders | keys[0]')

          # Extract latest changelog section
          LATEST=$(awk '/^## \[/{if(!found){found=1; next} else{exit}} found{print}' CHANGELOG.md)
          CLEAN=$(echo "$LATEST" | sed '/^EOF/d')

          {
            echo "project_version=$VERSION"
            echo "project_full_name=$NAME $VERSION"
            echo "mc_version=$MC_VERSION"
            echo "loader_type=$LOADER_TYPE"

            echo "changelog<<EOF"
            echo "$CLEAN"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

  discord-message:
    name: Discord Message
    needs: info
    runs-on: ubuntu-latest
    if: github.repository_owner == 'irunatbullets'
    steps:
      - name: Prepare Discord changelog
        id: discord_changelog
        run: |
          # Escape newlines from the info job
          ESCAPED=$(echo "${{ needs.info.outputs.changelog }}" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "changelog_escaped=$ESCAPED" >> "$GITHUB_OUTPUT"
      - name: Send Discord message
        uses: hugoalh/send-discord-webhook-ghaction@v7.0.5
        with:
          key: "${{ secrets.DISCORD_WEBHOOK }}"
          username: "irunatbullets"
          avatar_url: "https://cdn.modrinth.com/data/PoHFfv3G/53d3a9085947f25804334a2c5de8f656f3bb2f20.png"
          content_links_no_embed: .+
          content: |
            # [Surface Living — New Release [${{ needs.info.outputs.project_version }}]](https://modrinth.com/modpack/surface-living/version/${{ needs.info.outputs.project_version }})
            A fresh update to **Surface Living** is out.

            ${{ needs.info.outputs.changelog }}
            
            **Pack Version:** ${{ needs.info.outputs.project_version }}
            **Loader:** ${{ needs.info.outputs.loader_type }}
            **Minecraft:** ${{ needs.info.outputs.mc_version }}

            ### Links
            → [View this release on Modrinth](https://modrinth.com/modpack/surface-living/version/${{ needs.info.outputs.project_version }})
            → [Issue tracker & feedback](https://github.com/irunatbullets/surface-living/issues)
            → [Full changelog](https://github.com/irunatbullets/surface-living/blob/main/CHANGELOG.md)
            → [Optional support](https://ko-fi.com/irunatbullets)


          embeds: |
            [
              {
                "title": "Surface Living — New Release [${{ needs.info.outputs.project_version }}]",
                "url": "https://modrinth.com/modpack/surface-living/version/${{ needs.info.outputs.project_version }}",
                "color": 5763719,
                "description": "A fresh update to **Surface Living** is out.\n
                ${{ steps.discord_changelog.outputs.changelog_escaped }}\n
                \n
                **Pack Version:** ${{ needs.info.outputs.project_version }}\n
                **Loader:** ${{ needs.info.outputs.loader_type }}\n
                **Minecraft:** ${{ needs.info.outputs.mc_version }}",
                "fields": [
                  {
                    "name": "Links",
                    "value": "→ [View this release on Modrinth](https://modrinth.com/modpack/surface-living/version/${{ needs.info.outputs.project_version }})\n
                    → [Issue tracker & feedback](https://github.com/irunatbullets/surface-living/issues)\n
                    → [Full changelog](https://github.com/irunatbullets/surface-living/blob/main/CHANGELOG.md)\n
                    → [Optional support](https://ko-fi.com/irunatbullets)"
                  }
                ],
                "thumbnail": {
                  "url": "https://cdn.modrinth.com/data/mPwYBsJ3/images/25bd95745cd6cc5d7d25c34c642792ffbdd48ead.png"
                }
              }
            ]
